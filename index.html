<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<!DOCTYPE html>
<html>
   <head>
      <title>Buckhouse</title>
      <!-- Angular -->
      <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
      <!-- Font awesome -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
      <!-- Leaflet CSS -->
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
       <!-- Make sure you put this AFTER Leaflet's CSS -->
      <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
      <script src="allData.js"></script>
      <style type="text/css">
         /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #mapid { height: 75% }
      </style>
   </head>
   <body ng-app="myApp" ng-controller="myCtrl">
      <div class="container-fluid">
         <h1>Johnathan's Ski Resort challenge</h1>
         <div id="mapid"></div>
         <!-- THE SEARCH BOX  -->
         <!-- Search <input type="text" ng-model="search" placeholder="Enter some text to search"/> -->
         <h3 id="visitCount"></h3>
         <table class="table">
            <tr>
               <th>Resort Name</th>
               <th>Region</th>
               <th>State</th>
               <th>City</th>
               <th>Number of Videos</th>
            </tr>
            <tr ng-repeat="data in allData | filter : search" onclick="tableRowClick(this)">
               <td>
                  <i ng-show="data.videos.length>0" class="fa fa-check-square"></i> 
                  <i ng-show="data.videos.length===0" class="fa fa-square"></i>
                  <span>{{data.resortName}}</span>
               </td>
               <td>{{data.region}}</td>
               <td>{{data.state}}</td>
               <td>{{data.city}}</td>
               <td>{{data.videos.length}}</td>
               <!-- <td>{{data.videos}}</td> -->
            </tr>
         </table>
      </div>
   </body>
   <script>

      // Code goes here
      var app = angular.module('myApp', []);
      
      // Governing app controller
      app.controller('myCtrl', ['$scope', function($scope) {
      
          $scope.allData = JSON.parse(JSON.stringify(allData));
      
      }])

      var mymap = L.map('mapid').setView([39.480243, -106.06667], 4);

      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 10,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
          'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
      }).addTo(mymap);

      var greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      var visitedCount = 0;

      for (var i = 0; i < allData.length; i++) {

        var visited = allData[i].videos.length > 0;

        visited ? visitedCount++ : undefined;

        var icon = visited > 0 ? greenIcon : redIcon;   

        var videoLinks = visited ? `<p>Here ${allData[i].videos.length === 1 ? 'is the only video' : 'are ' + allData[i].videos.length + ' videos (in a playlist)' }  of Johathan from this location!<p><p><iframe width="400" height="336" src="https://www.youtube-nocookie.com/embed/${allData[i].videos[0]}?playlist=${allData[i].videos.slice(1).join(',')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>` : '<p>Johnathan hasn\'t traveled here yet! Check back soon</p>';

        // var videoLinks = allData[i].videos.map(val => `<p><iframe width="300" height="169" src="https://www.youtube-nocookie.com/embed/${val}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>`).slice(0, 3).join('');
        // var moreVideos = `<iframe width="560" height="315" src="http://www.youtube.com/embed/${allData[i].videos[4]}?playlist=${allData[i].videos.slice(4).join(',')}" frameborder="0" allowfullscreen></iframe>`;
        // var moreVideos = allData[i].videos.map(val => `<p><a target="_blank" href="https://www.youtube.com/watch?v=${val}">VIDEO</a><p>`).slice(3).join('');

        var popupContent = '<div id="content">' +
                   '<div id="siteNotice">' +
                   '</div>' +
                   `<h3 id="firstHeading" class="firstHeading">${allData[i].resortName}, ${allData[i].state}</h3>` +
                   '<div id="bodyContent">' +
                   videoLinks +
                   '</div>' +
                   '</div>';

        var popupOptions = {
          // maxHeight: 600,
          minWidth: 400
        };

        L.marker([allData[i].position.lat, allData[i].position.lng], {icon: icon}).addTo(mymap)
        .bindPopup(popupContent, popupOptions)
        .bindTooltip(allData[i].resortName);
      }

      document.getElementById("visitCount").innerText = "Johnathan has visited " + visitedCount + " out of " + allData.length + " resorts so far!";
      
      //Pans to corresponding resort
      function tableRowClick(x) {
         var clickedResortInfoArray = (x.innerText.trim()).split("	");
         
         for (i = 0; i < allData.length; ++i) {
            var resort = allData[i];
            if(resort.resortName == clickedResortInfoArray[0] && resort.region == clickedResortInfoArray[1] && resort.city == clickedResortInfoArray[3]) {
               
               var coords = L.latLng(resort.position.lat, resort.position.lng);

               mymap.panTo(coords);

               //Wanted to open the narjer but it doesn't work
               //mymap.fireEvent('click', {latlng: coords});
            }
         }

      }

 </script>
</html>
